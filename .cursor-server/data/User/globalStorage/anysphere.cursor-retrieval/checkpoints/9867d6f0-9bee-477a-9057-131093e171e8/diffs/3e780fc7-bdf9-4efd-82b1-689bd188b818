{"fsPath":"/root/apps/server/src/lib/database.ts","fileUuid":"3e780fc7-bdf9-4efd-82b1-689bd188b818","fileSizeBytes":4121,"numLines":160,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":161,"addedLines":["import DatabaseDriver from 'better-sqlite3';","","export type BuilderCode = {","\tcode: string;","\townerAddress: string;","\tappUrl: string | null;","\tmetadataJson: string | null;","\tcreatedAt: number;","\tupdatedAt: number;","};","","export type CodeStats = {","\tcode: string;","\ttxCount: number;","\tvolumeEth: string; // store as string to avoid FP issues","\tfeeEstimateEth: string;","\tupdatedAt: number;","};","","export class Database {","\tprivate driver: DatabaseDriver.Database;","","\tconstructor(filePath: string) {","\t\tthis.driver = new DatabaseDriver(filePath);","\t\tthis.driver.pragma('journal_mode = WAL');","\t}","","\tasync init(): Promise<void> {","\t\tthis.driver","\t\t\t.prepare(","\t\t\t\t`","        CREATE TABLE IF NOT EXISTS builder_codes (","          code TEXT PRIMARY KEY,","          owner_address TEXT NOT NULL,","          app_url TEXT,","          metadata_json TEXT,","          created_at INTEGER NOT NULL,","          updated_at INTEGER NOT NULL","        );","      `","\t\t\t)","\t\t\t.run();","","\t\tthis.driver","\t\t\t.prepare(","\t\t\t\t`","        CREATE TABLE IF NOT EXISTS code_stats (","          code TEXT PRIMARY KEY,","          tx_count INTEGER NOT NULL,","          volume_eth TEXT NOT NULL,","          fee_estimate_eth TEXT NOT NULL,","          updated_at INTEGER NOT NULL,","          FOREIGN KEY (code) REFERENCES builder_codes(code) ON DELETE CASCADE","        );","      `","\t\t\t)","\t\t\t.run();","","\t\tthis.driver","\t\t\t.prepare(","\t\t\t\t`","        CREATE TABLE IF NOT EXISTS tx_attributions (","          tx_hash TEXT PRIMARY KEY,","          code TEXT NOT NULL,","          timestamp INTEGER NOT NULL,","          value_eth TEXT NOT NULL,","          fee_estimate_eth TEXT NOT NULL,","          FOREIGN KEY (code) REFERENCES builder_codes(code) ON DELETE CASCADE","        );","      `","\t\t\t)","\t\t\t.run();","\t}","","\tupsertBuilderCode(input: Omit<BuilderCode, 'createdAt' | 'updatedAt'>): void {","\t\tconst now = Date.now();","\t\tthis.driver","\t\t\t.prepare(","\t\t\t\t`","        INSERT INTO builder_codes (code, owner_address, app_url, metadata_json, created_at, updated_at)","        VALUES (@code, @ownerAddress, @appUrl, @metadataJson, @now, @now)","        ON CONFLICT(code) DO UPDATE SET","          owner_address=excluded.owner_address,","          app_url=excluded.app_url,","          metadata_json=excluded.metadata_json,","          updated_at=excluded.updated_at","      `","\t\t\t)","\t\t\t.run({ ...input, now });","\t}","","\tupdateCodeStats(input: Omit<CodeStats, 'updatedAt'>): void {","\t\tconst now = Date.now();","\t\tthis.driver","\t\t\t.prepare(","\t\t\t\t`","        INSERT INTO code_stats (code, tx_count, volume_eth, fee_estimate_eth, updated_at)","        VALUES (@code, @txCount, @volumeEth, @feeEstimateEth, @now)","        ON CONFLICT(code) DO UPDATE SET","          tx_count=excluded.tx_count,","          volume_eth=excluded.volume_eth,","          fee_estimate_eth=excluded.fee_estimate_eth,","          updated_at=excluded.updated_at","      `","\t\t\t)","\t\t\t.run({ ...input, now });","\t}","","\tinsertAttribution(input: {","\t\ttxHash: string;","\t\tcode: string;","\t\ttimestamp: number;","\t\tvalueEth: string;","\t\tfeeEstimateEth: string;","\t}): void {","\t\tthis.driver","\t\t\t.prepare(","\t\t\t\t`","        INSERT OR IGNORE INTO tx_attributions (tx_hash, code, timestamp, value_eth, fee_estimate_eth)","        VALUES (@txHash, @code, @timestamp, @valueEth, @feeEstimateEth)","      `","\t\t\t)","\t\t\t.run(input);","\t}","","\tgetLeaderboard(limit = 50): Array<{","\t\tcode: string;","\t\ttxCount: number;","\t\tvolumeEth: string;","\t\tfeeEstimateEth: string;","\t\tappUrl: string | null;","\t\townerAddress: string;","\t}> {","\t\tconst rows = this.driver","\t\t\t.prepare(","\t\t\t\t`","        SELECT s.code, s.tx_count as txCount, s.volume_eth as volumeEth, s.fee_estimate_eth as feeEstimateEth,","               c.app_url as appUrl, c.owner_address as ownerAddress","        FROM code_stats s","        JOIN builder_codes c ON c.code = s.code","        ORDER BY s.fee_estimate_eth + 0.0 DESC, s.volume_eth + 0.0 DESC","        LIMIT ?","      `","\t\t\t)","\t\t\t.all(limit);","\t\treturn rows as any;","\t}","","\tgetCode(code: string): BuilderCode | undefined {","\t\tconst row = this.driver","\t\t\t.prepare(","\t\t\t\t`SELECT code, owner_address as ownerAddress, app_url as appUrl, metadata_json as metadataJson, created_at as createdAt, updated_at as updatedAt FROM builder_codes WHERE code = ?`","\t\t\t)","\t\t\t.get(code);","\t\treturn row as any;","\t}","}","","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000007,1000008,1000009,1000001,1000010,1000003,1000011,1000012,1000013,1000008,1000009,1000001,1000014,1000015,1000001,1000016,1000017,1000018,1000019,1000001,1000020,1000021,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000001,1000021,1000022,1000023,1000035,1000025,1000036,1000037,1000038,1000039,1000040,1000031,1000032,1000033,1000034,1000001,1000021,1000022,1000023,1000041,1000042,1000043,1000044,1000045,1000038,1000040,1000031,1000032,1000033,1000034,1000019,1000001,1000046,1000047,1000021,1000022,1000023,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000032,1000033,1000055,1000019,1000001,1000056,1000047,1000021,1000022,1000023,1000057,1000058,1000050,1000059,1000060,1000061,1000054,1000032,1000033,1000055,1000019,1000001,1000062,1000063,1000064,1000065,1000066,1000067,1000068,1000021,1000022,1000023,1000069,1000070,1000032,1000033,1000071,1000019,1000001,1000072,1000064,1000073,1000074,1000067,1000075,1000076,1000077,1000078,1000022,1000023,1000079,1000080,1000081,1000082,1000083,1000084,1000032,1000033,1000085,1000086,1000019,1000001,1000087,1000088,1000022,1000089,1000033,1000090,1000091,1000019,1000092,1000001,1000001,1000001]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}