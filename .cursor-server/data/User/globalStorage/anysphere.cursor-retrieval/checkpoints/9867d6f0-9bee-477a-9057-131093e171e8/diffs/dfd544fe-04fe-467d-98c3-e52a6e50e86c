{"fsPath":"/root/apps/server/src/indexers/registryIndexer.ts","fileUuid":"dfd544fe-04fe-467d-98c3-e52a6e50e86c","fileSizeBytes":2225,"numLines":65,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":66,"addedLines":["import 'dotenv/config';","import { ethers } from 'ethers';","import { Database } from '../lib/database.js';","","// Placeholder ABI and address. Replace when canonical registry ABI/address is confirmed.","const REGISTRY_ADDRESS = process.env.REGISTRY_ADDRESS as string;","const REGISTRY_ABI = [","\t// event Registered(string indexed code, address indexed owner, string metadataURI, string appUrl)","\t'event Registered(string indexed code, address indexed owner, string metadataURI, string appUrl)',","\t// event Updated(string indexed code, address indexed owner, string metadataURI, string appUrl)","\t'event Updated(string indexed code, address indexed owner, string metadataURI, string appUrl)'","];","","async function main() {","\tif (!process.env.BASE_RPC_URL) throw new Error('BASE_RPC_URL missing');","\tif (!REGISTRY_ADDRESS) throw new Error('REGISTRY_ADDRESS missing');","","\tconst provider = new ethers.JsonRpcProvider(process.env.BASE_RPC_URL);","\tconst registry = new ethers.Contract(REGISTRY_ADDRESS, REGISTRY_ABI, provider);","\tconst db = new Database(process.env.DATABASE_PATH ?? 'builderscan.db');","\tawait db.init();","","\tconst fromBlock = Number(process.env.START_BLOCK ?? 0);","\tconst current = await provider.getBlockNumber();","","\tconst filterRegistered = registry.filters.Registered();","\tconst filterUpdated = registry.filters.Updated();","","\tconst [registeredLogs, updatedLogs] = await Promise.all([","\t\tregistry.queryFilter(filterRegistered, fromBlock, current),","\t\tregistry.queryFilter(filterUpdated, fromBlock, current)","\t]);","","\tfor (const log of registeredLogs) {","\t\tconst { code, owner, metadataURI, appUrl } = (log.args ?? {}) as any;","\t\tdb.upsertBuilderCode({","\t\t\tcode,","\t\t\townerAddress: owner,","\t\t\tappUrl: appUrl ?? null,","\t\t\tmetadataJson: metadataURI ? JSON.stringify({ metadataURI }) : null","\t\t});","\t}","","\tfor (const log of updatedLogs) {","\t\tconst { code, owner, metadataURI, appUrl } = (log.args ?? {}) as any;","\t\tdb.upsertBuilderCode({","\t\t\tcode,","\t\t\townerAddress: owner,","\t\t\tappUrl: appUrl ?? null,","\t\t\tmetadataJson: metadataURI ? JSON.stringify({ metadataURI }) : null","\t\t});","\t}","","\tconsole.log(","\t\t`Indexed registry logs. Registered: ${registeredLogs.length}, Updated: ${updatedLogs.length}`","\t);","}","","main().catch((err) => {","\tconsole.error(err);","\tprocess.exit(1);","});","","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000003,1000012,1000013,1000014,1000003,1000015,1000016,1000017,1000018,1000003,1000019,1000020,1000003,1000021,1000022,1000003,1000023,1000024,1000025,1000026,1000003,1000027,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000035,1000003,1000036,1000028,1000029,1000030,1000031,1000032,1000033,1000034,1000035,1000003,1000037,1000038,1000039,1000040,1000003,1000041,1000042,1000043,1000044,1000003,1000003,1000003]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}