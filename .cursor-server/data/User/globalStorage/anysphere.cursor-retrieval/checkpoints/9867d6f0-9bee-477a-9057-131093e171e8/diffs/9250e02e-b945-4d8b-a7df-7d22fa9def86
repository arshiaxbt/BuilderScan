{"fsPath":"/root/apps/server/src/indexers/attributionIndexer.ts","fileUuid":"9250e02e-b945-4d8b-a7df-7d22fa9def86","fileSizeBytes":2787,"numLines":88,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":89,"addedLines":["import 'dotenv/config';","import { ethers } from 'ethers';","import { Database } from '../lib/database.js';","","// ERC-8021 parsing placeholder. Replace with exact schema 0 parsing when confirmed.","function extractBuilderCodeFromCalldata(data: string): string | null {","\t// Heuristic: 8021 suffix commonly appended as ascii tag '|8021:' + code at end.","\t// This is a placeholder and should be replaced with canonical parsing.","\ttry {","\t\tif (!data || data === '0x') return null;","\t\t// Try to decode tail as UTF-8 and find 8021 marker","\t\tconst bytes = ethers.getBytes(data);","\t\tconst utf8 = new TextDecoder().decode(bytes);","\t\tconst marker = '|8021:';","\t\tconst idx = utf8.lastIndexOf(marker);","\t\tif (idx >= 0) {","\t\t\tconst code = utf8.slice(idx + marker.length).trim();","\t\t\tif (code && code.length <= 64) return code;","\t\t}","\t\treturn null;","\t} catch {","\t\treturn null;","\t}","}","","async function main() {","\tif (!process.env.BASE_RPC_URL) throw new Error('BASE_RPC_URL missing');","\tconst provider = new ethers.JsonRpcProvider(process.env.BASE_RPC_URL);","\tconst db = new Database(process.env.DATABASE_PATH ?? 'builderscan.db');","\tawait db.init();","","\tconst fromBlock = Number(process.env.START_BLOCK ?? 0);","\tconst current = await provider.getBlockNumber();","","\t// Scan blocks in windows","\tconst step = 1000;","\tfor (let start = fromBlock; start <= current; start += step) {","\t\tconst end = Math.min(current, start + step - 1);","\t\tconst blocks = await Promise.all(","\t\t\tArray.from({ length: end - start + 1 }).map((_, i) => provider.getBlock(start + i, true))","\t\t);","","\t\tfor (const block of blocks) {","\t\t\tif (!block?.transactions) continue;","\t\t\tfor (const tx of block.transactions as any[]) {","\t\t\t\tconst code = extractBuilderCodeFromCalldata(tx.input as string);","\t\t\t\tif (!code) continue;","\t\t\t\tconst valueEth = ethers.formatEther(tx.value ?? 0n);","\t\t\t\t// naive fee estimate: 0.05% of value, fallback to 0","\t\t\t\tconst feeEstimateEth =","\t\t\t\t\ttx.value && tx.value > 0n","\t\t\t\t\t\t? (Number(valueEth) * 0.0005).toString()","\t\t\t\t\t\t: '0';","\t\t\t\tdb.insertAttribution({","\t\t\t\t\ttxHash: tx.hash,","\t\t\t\t\tcode,","\t\t\t\t\ttimestamp: Number(block.timestamp),","\t\t\t\t\tvalueEth,","\t\t\t\t\tfeeEstimateEth","\t\t\t\t});","\t\t\t}","\t\t}","\t\tconsole.log(`Scanned blocks ${start}-${end}`);","\t}","","\t// Aggregate stats","\tconst codesStmt = (db as any).driver.prepare(","\t\t`SELECT code, COUNT(*) as txCount, COALESCE(SUM(value_eth + 0.0), 0) as volumeEth, COALESCE(SUM(fee_estimate_eth + 0.0), 0) as feeEstimateEth FROM tx_attributions GROUP BY code`","\t);","\tconst rows = codesStmt.all() as Array<any>;","\tfor (const row of rows) {","\t\tdb.updateCodeStats({","\t\t\tcode: row.code,","\t\t\ttxCount: Number(row.txCount),","\t\t\tvolumeEth: String(row.volumeEth),","\t\t\tfeeEstimateEth: String(row.feeEstimateEth)","\t\t});","\t}","\tconsole.log(`Aggregated stats for ${rows.length} codes`);","}","","main().catch((err) => {","\tconsole.error(err);","\tprocess.exit(1);","});","","",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000015,1000016,1000017,1000018,1000019,1000020,1000019,1000021,1000022,1000003,1000023,1000024,1000025,1000026,1000027,1000003,1000028,1000029,1000003,1000030,1000031,1000032,1000033,1000034,1000035,1000036,1000003,1000037,1000038,1000039,1000040,1000041,1000042,1000043,1000044,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000054,1000055,1000018,1000056,1000021,1000003,1000057,1000058,1000059,1000060,1000061,1000062,1000063,1000064,1000065,1000066,1000067,1000068,1000021,1000069,1000022,1000003,1000070,1000071,1000072,1000073,1000003,1000003,1000003]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}